<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI-Team Web • Projects</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="nav">
        <div class="left">
          <strong>AI-Team Web</strong>
          <a href="/intake">Intake</a>
          <a href="/interview">Interview</a>
          <a href="/projects" class="active">Projects</a>
          <a href="/lane-a/health">Lane A Status</a>
        </div>
        <div class="right">
          <button id="logoutBtn" class="danger">Logout</button>
        </div>
      </div>

      <div class="row two">
        <div class="card">
          <label>Projects</label>
          <div class="hint" style="margin-top: 8px;">Read-only. Source of truth: `AI-Team/ai/registry/REGISTRY.json`.</div>
          <div style="display:flex; gap:10px; margin-top: 12px; align-items: center;">
            <button id="refreshBtn">Refresh</button>
            <select id="projectSelect" style="flex:1;"></select>
          </div>
          <div class="hint" id="summary" style="margin-top: 10px;"></div>
        </div>

        <div class="card">
          <label>Detail</label>
          <div class="out" id="out"></div>
        </div>
      </div>
    </div>

    <script src="/static/ui.js"></script>
    <script>
      const out = document.getElementById("out");
      const select = document.getElementById("projectSelect");
      const summary = document.getElementById("summary");

      function show(obj) {
        out.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }

      async function apiGet(path) {
        const res = await fetch(path, { method: "GET", credentials: "include" });
        const json = await res.json().catch(() => ({}));
        return { status: res.status, ok: res.ok, json };
      }

      async function logout() {
        await fetch("/api/logout", { method: "POST", headers: { "Content-Type": "application/json" }, credentials: "include", body: "{}" });
        window.location.href = "/login";
      }
      document.getElementById("logoutBtn").addEventListener("click", logout);

      function setOptions(projects) {
        select.innerHTML = "";
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "(select project)";
        select.appendChild(opt0);
        for (const p of projects) {
          const o = document.createElement("option");
          o.value = p.project_code;
          o.textContent = `${p.project_code} (${p.status})`;
          select.appendChild(o);
        }
      }

      async function refreshList() {
        show("Loading…");
        const r = await apiGet("/api/projects");
        if (!r.ok || !r.json || r.json.ok !== true) {
          show(r.json && typeof r.json === "object" ? r.json : r);
          return;
        }
        const projects = Array.isArray(r.json.projects) ? r.json.projects : [];
        setOptions(projects);
        summary.textContent = `host_id: ${r.json.host_id} • projects: ${projects.length}`;
        show({ ok: true, projects });
      }

      async function loadDetail(code) {
        if (!code) {
          show("Select a project to view detail.");
          return;
        }
        show("Loading…");
        const r = await apiGet(`/api/projects/${encodeURIComponent(code)}`);
        if (!r.ok) return show(r.json && typeof r.json === "object" ? r.json : r);
        show(r.json);
      }

      document.getElementById("refreshBtn").addEventListener("click", refreshList);
      select.addEventListener("change", () => loadDetail(select.value));

      refreshList();
    </script>
  </body>
</html>
